<udebs>

<config>
    <revert>0</revert>
    <version>2</version>
    <logging>False</logging>
    <immutable>True</immutable>
</config>

<definitions>
    <stats>
        <amount />
        <chests />
        <keys />
        <skulls />
        <draws />
        <lives />
        <score />
    </stats>

    <lists>
        <cards rlist="True" />
    </lists>

</definitions>

<entities>
    <!-- Cards -->
    <cards />

    <boat>
        <amount>9</amount>
        <group>cards</group>
    </boat>

    <dmap>
        <amount>9</amount>
        <group>cards</group>
        <draws>2</draws>
    </dmap>

    <map>
        <amount>9</amount>
        <group>cards</group>
        <draws>1</draws>
    </map>

    <skull>
        <amount>9</amount>
        <group>cards</group>
        <skulls>1</skulls>
    </skull>

    <chest>
        <amount>9</amount>
        <group>cards</group>
        <chests>1</chests>
    </chest>

    <key>
        <amount>9</amount>
        <group>cards</group>
        <keys>1</keys>
    </key>

    <!-- system -->
    <hands />

    <hand immutable="False">
        <group>hands</group>
        <lives>3</lives>
    </hand>

    <deck immutable="False" />

    <!-- Shuffle deck -->
    <shuffle>
        <effect>
            <i>ALL.hands CLEAR cards</i>
            <i>ALL.cards CAST $caster insert</i>
            <i>$caster SHUFFLE cards</i>
        </effect>
    </shuffle>

    <insert>
        <require>$caster.NAME not-in $target.STAT.cards $caster.STAT.amount</require>
        <effect>
            <i>$target cards GETS $caster.NAME</i>
            <i>$caster CAST $target insert</i>
        </effect>
    </insert>

    <!-- Draw a random card from the deck -->
    <draw>
        <require>
            <i>(length $caster.STAT.cards) &lt; $caster.STAT.draws</i>
            <i>drawn = ($target.STAT.cards elem 0)</i>
            <i>$drawn != empty</i>
        </require>
        <effect>
            <i>$target cards LOSES $drawn.NAME</i>
            <i>$caster cards GETS $drawn.NAME</i>
            <i>print $caster has drawn $drawn</i>
            <i>$caster CAST $target draw</i>
        </effect>
    </draw>

    <!-- Hand Actions -->
    <checkdeath>
        <require>$caster.STAT.skulls &gt;= $caster.STAT.lives</require>
        <effect>
            <i>print $caster has died</i>
            <i>EXIT</i>
        </effect>
    </checkdeath>

    <tally>
        <effect>
            <i>chests = $caster.STAT.chests</i>
            <i>keys = $caster.STAT.keys</i>
            <i>score = (($chests * 2) + (min $chests $keys))</i>
            <i>hand score REPLACE $score</i>
        </effect>
    </tally>

    <!-- System Actions -->
    <resolve>
         <effect>
            <i>hand CAST deck draw</i>
            <i>hand ACTION tally</i>
            <i>print hand has hand.STAT.score points</i>
            <i>print hand has hand.STAT.skulls skulls</i>
            <i>hand ACTION checkdeath</i>
        </effect>
    </resolve>

    <init>
        <group>resolve</group>
        <effect>
            <i>deck ACTION shuffle</i>
            <i>hand draws REPLACE 3</i>
        </effect>
    </init>

    <tick>
        <group>resolve</group>
        <effect>hand draws += 1</effect>
    </tick>

    <!-- Draw a specific card from the deck -->
    <drawsingle>
        <require>$target.NAME in deck.STAT.cards</require>
        <effect>
            <i>deck cards LOSES $target.NAME</i>
            <i>$caster cards GETS $target.NAME</i>
            <i>hand ACTION tally</i>
        </effect>
    </drawsingle>

</entities>
</udebs>
