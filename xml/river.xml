<udebs>

<config>
    <hex>True</hex>
    <logging>False</logging>
    <version>2</version>
</config>

<definitions>
    <stats>
        <water />
        <dirt />
        <erosion />
        <hardness />
    </stats>
    <lists>
        <change />
    </lists>
    <strings>
        <colour />
    </strings>
</definitions>

<map>
    <dim>
        <x>16</x>
        <y>16</y>
    </dim>
</map>

<entities>
    <!-- scripts -->
    <init>
        <effect>
            <i>total = (FILL (0 0) empty)</i>
            <i>land RECRUIT $total</i>
            <i>CAST $total terrain</i>
            <i>source MOVE (0 0)</i>
            <i>pit MOVE (15 15)</i>
            <i>CAST empty updatecolour</i>
            <i>DELAY (INIT rain) (10000 + DICE.1000)</i>
        </effect>
    </init>

    <rain>
        <effect>
            <i>(FILL (0 0) empty) water += 10</i>
            <i>DELAY (INIT rain) (10000 + DICE.1000)</i>
        </effect>
    </rain>

    <terrain>
        <effect>
            <i>$target hardness += DICE.200</i>
            <i>$target dirt += DICE.10</i>
        </effect>
    </terrain>

    <tick>
        <effect>
            <i>tick CLEAR change</i>
            <i>source water += 1</i>
            <i>pit water += (400 - pit.STAT.water)</i>
            <i>outflow = FILL.source.adjacent</i>
            <i>tick GAINS change $outflow</i>
            <i>source CAST $outflow flow</i>
        </effect>
    </tick>

    <adjacent>
        <require>
            <i>DISTANCE.hex == 1</i>
            <i>$target.LOC not-in tick.STAT.change</i>
        </require>
    </adjacent>

    <!-- moves -->

    <flow>
        <require>
            <i>difference =
                 (+ $caster.STAT.water
                    $caster.STAT.dirt
                    -($target STAT water)
                    -($target STAT dirt))</i>
            <i>|$difference &gt; 1</i>
            <i>flowout =
                 (if ($difference &gt; 0)
                     $caster
                     $target)</i>
            <i>$flowout.STAT.water &gt; 0</i>
            <i>flowin =
                 (if ($difference &gt; 0)
                     $target
                     $caster)</i>
        </require>
        <effect>
            <i>amount =
                 (min $flowout.STAT.water
                      ((|$difference + 1) / 2))</i>
            <i>$flowin water += $amount</i>
            <i>$flowout water -= $amount</i>
            <i>$flowout erosion += 1</i>
            <i>CAST $flowout erode</i>
            <i>inflow = (FILL $target adjacent)</i>
            <i>tick change GETS $inflow</i>
            <i>$target CAST $inflow flow</i>
        </effect>
    </flow>

    <erode>
        <require>
            <i>$target.STAT.dirt &gt; 0</i>
            <i>hard = $target.STAT.hardness</i>
            <i>$target.STAT.erosion >= $hard</i>
            <i>$target.NAME != source</i>
        </require>
        <effect>
            <i>$target erosion -= $hard</i>
            <i>$target dirt -= 1</i>
            <i>(FILL.$target.adjacent elem DICE.5) dirt += 1</i>
        </effect>
    </erode>

    <!-- colour updates every 50 ticks -->

    <updatecolour>
        <effect>
            <i>CAST (FILL (0 0) empty) colourchange</i>
            <i>DELAY (CAST empty updatecolour) 50</i>
        </effect>
    </updatecolour>

    <colourchange>
        <effect>
            <i>$target colour REPLACE ($move.STAT.change elem (min ($target.STAT.water / 10) 4))</i>
        </effect>
        <change>
            <i>sand</i>
            <i>dirt</i>
            <i>grass</i>
            <i>shallow</i>
            <i>deep</i>
        </change>
    </colourchange>

    <!-- land squares -->

    <land>
        <dirt>500</dirt>
        <colour>sand</colour>
    </land>

    <source>
        <water>500</water>
        <colour>deep</colour>
    </source>

    <pit>
        <water>200</water>
        <colour>deep</colour>
    </pit>

</entities>

</udebs>
